import { resend, FROM_EMAIL } from '../lib/resend.js';
import { Course, Order, User } from '../types/index.js';

interface OrderConfirmationData {
  user: User;
  course: Course;
  order: Order;
}

interface PixInstructionsData {
  user: User;
  course: Course;
  order: Order;
  pixCode: string;
  pixQrCode: string;
}

interface PaymentApprovedData {
  user: User;
  course: Course;
  order: Order;
}

export class EmailService {
  static async sendOrderConfirmation(data: OrderConfirmationData) {
    const { user, course, order } = data;

    const html = `
    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Confirma√ß√£o de Pedido - Global Trainer</title>
      <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; background-color: #f4f4f4; }
        .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; }
        .header { background-color: #3b82f6; color: white; padding: 20px; text-align: center; }
        .content { padding: 30px; }
        .order-details { background-color: #f8fafc; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .footer { background-color: #1f2937; color: white; padding: 20px; text-align: center; }
        .button { display: inline-block; background-color: #3b82f6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin: 20px 0; }
        @media (max-width: 600px) { .container { width: 100% !important; } .content { padding: 20px !important; } }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>üéì Global Trainer</h1>
          <h2>Confirma√ß√£o de Pedido</h2>
        </div>
        
        <div class="content">
          <p>Ol√° <strong>${user.name}</strong>,</p>
          
          <p>Recebemos seu pedido com sucesso! Aqui est√£o os detalhes:</p>
          
          <div class="order-details">
            <h3>üìã Detalhes do Pedido</h3>
            <p><strong>Pedido:</strong> #${order.id.slice(-8).toUpperCase()}</p>
            <p><strong>Curso:</strong> ${course.title}</p>
            <p><strong>Instrutor:</strong> ${course.instructor}</p>
            <p><strong>Valor:</strong> R$ ${(order.amount / 100).toFixed(2).replace('.', ',')}</p>
            <p><strong>M√©todo de Pagamento:</strong> ${order.payment_method === 'pix' ? 'PIX' : order.payment_method === 'credit_card' ? 'Cart√£o de Cr√©dito' : 'Boleto Banc√°rio'}</p>
            <p><strong>Status:</strong> Aguardando Pagamento</p>
          </div>
          
          ${order.payment_method === 'pix' ? `
            <p>üì± <strong>Pr√≥ximos passos para PIX:</strong></p>
            <p>Voc√™ receber√° em breve um e-mail com o c√≥digo PIX e QR Code para realizar o pagamento.</p>
          ` : order.payment_method === 'boleto' ? `
            <p>üè¶ <strong>Pr√≥ximos passos para Boleto:</strong></p>
            <p>Voc√™ receber√° em breve um e-mail com o boleto banc√°rio para pagamento.</p>
          ` : `
            <p>üí≥ <strong>Pagamento com Cart√£o:</strong></p>
            <p>Seu pagamento est√° sendo processado. Voc√™ receber√° uma confirma√ß√£o em breve.</p>
          `}
          
          <p>Assim que o pagamento for confirmado, voc√™ receber√° acesso imediato ao curso!</p>
          
          <a href="${process.env.VITE_APP_URL}/student/dashboard" class="button">Acessar Minha √Årea</a>
        </div>
        
        <div class="footer">
          <p>¬© 2024 Global Trainer. Todos os direitos reservados.</p>
          <p>D√∫vidas? Entre em contato: suporte@globaltrainer.com.br</p>
        </div>
      </div>
    </body>
    </html>
    `;

    try {
      const result = await resend.emails.send({
        from: FROM_EMAIL,
        to: user.email,
        subject: `Confirma√ß√£o de Pedido - ${course.title}`,
        html
      });

      console.log('Email de confirma√ß√£o enviado:', result.data?.id);
      return result;
    } catch (error) {
      console.error('Erro ao enviar email de confirma√ß√£o:', error);
      throw error;
    }
  }

  static async sendPixInstructions(data: PixInstructionsData) {
    const { user, course, order, pixCode, pixQrCode } = data;

    const html = `
    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Instru√ß√µes PIX - Global Trainer</title>
      <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; background-color: #f4f4f4; }
        .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; }
        .header { background-color: #10b981; color: white; padding: 20px; text-align: center; }
        .content { padding: 30px; }
        .pix-details { background-color: #f0fdf4; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #10b981; }
        .pix-code { background-color: #f9fafb; padding: 15px; border-radius: 6px; font-family: monospace; word-break: break-all; margin: 10px 0; }
        .footer { background-color: #1f2937; color: white; padding: 20px; text-align: center; }
        .qr-code { text-align: center; margin: 20px 0; }
        @media (max-width: 600px) { .container { width: 100% !important; } .content { padding: 20px !important; } }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>üéì Global Trainer</h1>
          <h2>üì± Instru√ß√µes para Pagamento PIX</h2>
        </div>
        
        <div class="content">
          <p>Ol√° <strong>${user.name}</strong>,</p>
          
          <p>Seu PIX est√° pronto! Siga as instru√ß√µes abaixo para finalizar o pagamento:</p>
          
          <div class="pix-details">
            <h3>üí∞ Detalhes do Pagamento</h3>
            <p><strong>Valor:</strong> R$ ${(order.amount / 100).toFixed(2).replace('.', ',')}</p>
            <p><strong>Curso:</strong> ${course.title}</p>
            <p><strong>Pedido:</strong> #${order.id.slice(-8).toUpperCase()}</p>
          </div>
          
          <h3>üì± Como pagar:</h3>
          <ol>
            <li><strong>Pelo QR Code:</strong> Abra o app do seu banco e escaneie o c√≥digo abaixo</li>
            <li><strong>Pelo c√≥digo PIX:</strong> Copie e cole o c√≥digo no seu app banc√°rio</li>
          </ol>
          
          <div class="qr-code">
            <img src="${pixQrCode}" alt="QR Code PIX" style="max-width: 200px; height: auto;" />
          </div>
          
          <h4>üîë C√≥digo PIX (Copia e Cola):</h4>
          <div class="pix-code">
            ${pixCode}
          </div>
          
          <p><strong>‚è∞ Importante:</strong> O PIX expira em 30 minutos. Ap√≥s o pagamento, voc√™ receber√° acesso imediato ao curso!</p>
          
          <p>üí° <strong>Dica:</strong> Mantenha este e-mail aberto para facilitar o pagamento.</p>
        </div>
        
        <div class="footer">
          <p>¬© 2024 Global Trainer. Todos os direitos reservados.</p>
          <p>D√∫vidas? Entre em contato: suporte@globaltrainer.com.br</p>
        </div>
      </div>
    </body>
    </html>
    `;

    try {
      const result = await resend.emails.send({
        from: FROM_EMAIL,
        to: user.email,
        subject: `PIX Pronto - ${course.title} - R$ ${(order.amount / 100).toFixed(2).replace('.', ',')}`,
        html
      });

      console.log('Email PIX enviado:', result.data?.id);
      return result;
    } catch (error) {
      console.error('Erro ao enviar email PIX:', error);
      throw error;
    }
  }

  static async sendPaymentApproved(data: PaymentApprovedData) {
    const { user, course, order } = data;

    const html = `
    <!DOCTYPE html>
    <html lang="pt-BR">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>Pagamento Aprovado - Global Trainer</title>
      <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; background-color: #f4f4f4; }
        .container { max-width: 600px; margin: 0 auto; background-color: #ffffff; }
        .header { background-color: #059669; color: white; padding: 20px; text-align: center; }
        .content { padding: 30px; }
        .success-box { background-color: #f0fdf4; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #059669; }
        .course-access { background-color: #eff6ff; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .footer { background-color: #1f2937; color: white; padding: 20px; text-align: center; }
        .button { display: inline-block; background-color: #059669; color: white; padding: 12px 24px; text-decoration: none; border-radius: 6px; margin: 20px 0; }
        @media (max-width: 600px) { .container { width: 100% !important; } .content { padding: 20px !important; } }
      </style>
    </head>
    <body>
      <div class="container">
        <div class="header">
          <h1>üéì Global Trainer</h1>
          <h2>‚úÖ Pagamento Aprovado!</h2>
        </div>
        
        <div class="content">
          <p>Parab√©ns <strong>${user.name}</strong>! üéâ</p>
          
          <div class="success-box">
            <h3>‚úÖ Pagamento Confirmado</h3>
            <p>Seu pagamento foi aprovado com sucesso!</p>
            <p><strong>Valor pago:</strong> R$ ${(order.amount / 100).toFixed(2).replace('.', ',')}</p>
            <p><strong>Pedido:</strong> #${order.id.slice(-8).toUpperCase()}</p>
          </div>
          
          <div class="course-access">
            <h3>üöÄ Acesso Liberado</h3>
            <p><strong>Curso:</strong> ${course.title}</p>
            <p><strong>Instrutor:</strong> ${course.instructor}</p>
            <p><strong>Dura√ß√£o:</strong> ${course.duration}</p>
            <p><strong>N√≠vel:</strong> ${course.level === 'beginner' ? 'Iniciante' : course.level === 'intermediate' ? 'Intermedi√°rio' : 'Avan√ßado'}</p>
            
            <p>üéØ <strong>Voc√™ j√° pode come√ßar a estudar!</strong></p>
          </div>
          
          <a href="${process.env.VITE_APP_URL}/student/courses/${course.id}" class="button">üéì Acessar Curso Agora</a>
          
          <p>üìö Voc√™ tamb√©m pode acessar todos os seus cursos na sua √°rea do aluno.</p>
          
          <a href="${process.env.VITE_APP_URL}/student/dashboard" class="button" style="background-color: #3b82f6;">üìä Minha √Årea do Aluno</a>
          
          <p><strong>üí° Dicas para aproveitar melhor:</strong></p>
          <ul>
            <li>üì± Acesse de qualquer dispositivo</li>
            <li>‚è∞ Estude no seu pr√≥prio ritmo</li>
            <li>üìù Fa√ßa anota√ß√µes durante as aulas</li>
            <li>ü§ù Participe dos f√≥runs de discuss√£o</li>
            <li>üèÜ Complete todos os exerc√≠cios</li>
          </ul>
        </div>
        
        <div class="footer">
          <p>¬© 2024 Global Trainer. Todos os direitos reservados.</p>
          <p>D√∫vidas? Entre em contato: suporte@globaltrainer.com.br</p>
          <p>üì± Siga-nos nas redes sociais para dicas e novidades!</p>
        </div>
      </div>
    </body>
    </html>
    `;

    try {
      const result = await resend.emails.send({
        from: FROM_EMAIL,
        to: user.email,
        subject: `üéâ Acesso Liberado - ${course.title}`,
        html
      });

      console.log('Email de pagamento aprovado enviado:', result.data?.id);
      return result;
    } catch (error) {
      console.error('Erro ao enviar email de pagamento aprovado:', error);
      throw error;
    }
  }
}